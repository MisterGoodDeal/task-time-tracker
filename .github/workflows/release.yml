name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üî® Compile TypeScript
        run: npm run compile

      - name: üìÅ Create build directory
        run: mkdir -p build

      - name: üì¶ Build VSIX package
        run: npm run package

      - name: üìù Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: üì¶ List build directory
        run: ls -la build/ || echo "Build directory not found"

      - name: üì¶ Get VSIX filename
        id: get_vsix
        run: |
          if [ -d build ]; then
            VSIX_FILE=$(find build -name "*.vsix" -type f | head -1)
            if [ -z "$VSIX_FILE" ]; then
              echo "‚ùå No VSIX file found in build directory"
              ls -la build/
              exit 1
            fi
            VSIX_NAME=$(basename "$VSIX_FILE")
            echo "FILE=$VSIX_FILE" >> $GITHUB_OUTPUT
            echo "NAME=$VSIX_NAME" >> $GITHUB_OUTPUT
            echo "‚úÖ Found VSIX file: $VSIX_FILE"
          else
            echo "‚ùå Build directory does not exist"
            exit 1
          fi

      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.get_vsix.outputs.FILE }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Release ${{ steps.get_version.outputs.VERSION }}

            ### üì¶ Installation

            Download the `.vsix` file and install it using:

            ```bash
            code --install-extension ${{ steps.get_vsix.outputs.NAME }}
            ```

            Or install it directly from the VS Code Extensions marketplace.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üì§ Publish to VS Code Marketplace
        run: npx @vscode/vsce publish --pat ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        continue-on-error: true
